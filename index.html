<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sakura.css/css/sakura.css" type="text/css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subsequence and Ion Input</title>
    <style>
    <style>
        html, body {
            max-width: 100%;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            height: 100vh;
        }

        body {
            padding: 20px !important;
        }
    
        .container {
            width: 100% !important;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
    
        #results {
            width: 100% !important;
            margin: 20px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: auto;
            height: calc(100vh - 200px);
            box-sizing: border-box;
        }

        .subsequences-and-ions {
            display: grid;
            grid-template-columns: 75% 25%;
            width: 100%;
            align-items: start;
        }

        .subsequences-section {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            justify-content: center;
            margin-top: 24px;
        }

        .subsequences-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 200px;
        }

        .subsequences-container input {
            width: 100%;
        }

        .ion-dropdowns {
            display: flex;
            gap: 20px;
            justify-content: flex-end;
            padding-right: 20px;
        }

        .ion-dropdown {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .ion-dropdown label {
            margin-bottom: 5px;
        }
        @media (max-width: 768px) {
            .subsequences-and-ions {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .ion-dropdowns {
                justify-content: center;
                padding-right: 0;
            }
        }
            .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    
    #loading {
        text-align: center;
        margin: 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    </style>
</head>
<body>
    <h1 style="text-align: center;">Enter Search Parameters</h1>
    
    <div class="container">
            <div class="subsequences-and-ions">
                <div class="subsequences-section">
                    <div class="subsequences-container" id="subsequences">
                        <input type="text" name="subsequence" placeholder="Enter subsequence">
                    </div>
                    <button type="button" onclick="addNewSubsequence()">+</button>
                </div>
            <div class="ion-dropdowns">
                <div class="ion-dropdown">
                    <label for="k">K+</label>
                    <select id="k" name="k">
                        <option value="">Select</option>
                        <option value="0">0 mM</option>
                        <option value="50">50 mM</option>
                        <option value="100">100 mM</option>
                        <option value="150">150 mM</option>
                    </select>
                </div>
                <div class="ion-dropdown">
                    <label for="na">Na+</label>
                    <select id="na" name="na">
                        <option value="">Select</option>
                        <option value="0">0 mM</option>
                        <option value="50">50 mM</option>
                        <option value="100">100 mM</option>
                        <option value="150">150 mM</option>
                    </select>
                </div>
                <div class="ion-dropdown">
                    <label for="li_nh4">Li+/NH4+</label>
                    <select id="li_nh4" name="li_nh4">
                        <option value="">Select</option>
                        <option value="0">0 mM</option>
                        <option value="50">50 mM</option>
                        <option value="100">100 mM</option>
                        <option value="150">150 mM</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <style>
    .ion-dropdowns {
        display: flex;
        gap: 20px;
    }
    
    .ion-dropdown {
        display: flex;
        flex-direction: column;
    }
    
    .ion-dropdown label {
        margin-bottom: 5px;
    }
    </style>

    <div style="text-align: center;">
        <button onclick="searchSequences()">Search</button>
    </div>
    
    <div id="loading" style="display: none;">
    <div class="loading-spinner"></div>
    <div>Loading data... <span id="progress">0/0</span> files</div>
    </div>
    <div id="results"></div>

    <script>
let globalData = null;
let isLoading = false;

async function loadInitialData() {
    if (isLoading || globalData) return;
    
    isLoading = true;
    const loadingDiv = document.getElementById('loading');
    const progressSpan = document.getElementById('progress');
    loadingDiv.style.display = 'block';

    try {
        // Change 20 to match your number of files (e.g., 5 for 5 files, 100 for 100 files)
        // const files = [...Array(20)].map((_, i) => `file${i + 1}.csv`);
        const files = ['test1.csv', 'test.csv'];  // Your current files
        const baseUrl = 'https://donn-liew.github.io/my-test-static-page/data/';
        
        progressSpan.textContent = `0/${files.length}`;
        
        let allData = [];
        let headers = null;
        
        for(let i = 0; i < files.length; i++) {
            const response = await fetch(baseUrl + files[i]);
            const csvText = await response.text();
            const rows = csvText.split('\n').map(row => row.split(','));
            
            if (!headers) {
                headers = rows[0];
            }
            
            allData.push(...rows.slice(1));
            progressSpan.textContent = `${i + 1}/${files.length}`;
        }

        globalData = {
            headers: headers,
            data: allData
        };
        
        loadingDiv.style.display = 'none';
    } catch (error) {
        console.error('Error loading data:', error);
        loadingDiv.innerHTML = 'Error loading data. Please refresh the page.';
    } finally {
        isLoading = false;
    }
}

function addNewSubsequence() {
    const container = document.getElementById('subsequences');
    const newInput = document.createElement('input');
    newInput.type = 'text';
    newInput.name = 'subsequence';
    newInput.placeholder = 'Enter subsequence';
    container.appendChild(newInput);
}

async function searchSequences() {
    try {
        const k = document.getElementById('k').value;
        const na = document.getElementById('na').value;
        const li_nh4 = document.getElementById('li_nh4').value;

        if (!k || !na || !li_nh4) {
            let missingIons = [];
            if (!k) missingIons.push('K+');
            if (!na) missingIons.push('Na+');
            if (!li_nh4) missingIons.push('Li+/NH4+');
            
            document.getElementById('results').innerHTML = 
                `<p style="color: red;">Error: Please select concentrations for: ${missingIons.join(', ')}</p>`;
            return;
        }

        if (!globalData) {
            await loadInitialData();
        }
        
        const subsequenceInputs = document.querySelectorAll('input[name="subsequence"]');
        const subsequences = Array.from(subsequenceInputs)
            .map(input => input.value)
            .filter(value => value.trim() !== '');

        const sequenceIdx = globalData.headers.indexOf('sequence');
        const kIdx = globalData.headers.indexOf('k');
        const naIdx = globalData.headers.indexOf('na');
        const liNh4Idx = globalData.headers.indexOf('li/nh4');

        const results = globalData.data.filter(row => {
            const sequence = row[sequenceIdx];
            
            const sequenceMatch = subsequences.length === 0 || 
                subsequences.every(subseq => sequence && subseq && sequence.includes(subseq));
            
            const kMatch = !k || row[kIdx] === k;
            const naMatch = !na || row[naIdx] === na;
            const liNh4Match = !li_nh4 || row[liNh4Idx] === li_nh4;

            return sequenceMatch && kMatch && naMatch && liNh4Match;
        });

        displayResults(globalData.headers, results);
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('results').innerHTML = 
            `<p style="color: red;">Error searching data: ${error.message}</p>`;
    }
}

function displayResults(headers, results) {
    const resultsDiv = document.getElementById('results');
    
    if (results.length === 0) {
        resultsDiv.innerHTML = '<p>No matches found.</p>';
        return;
    }

    const dataHeaders = headers.slice(1);
    const maxDisplay = 10000;
    const displayResults = results.slice(0, maxDisplay);
    
    let noteText = results.length > maxDisplay ? 
        `<p style="color: #666;">(Only first ${maxDisplay.toLocaleString()} results are shown)</p>` : '';
    
    let tableHTML = `
        <h2>Results (${results.length.toLocaleString()} matches found)</h2>
        ${noteText}
        <table>
            <thead>
                <tr>
                    ${dataHeaders.map(header => `<th>${header}</th>`).join('')}
                </tr>
            </thead>
            <tbody>
                ${displayResults.map(row => `
                    <tr>
                        ${row.slice(1).map(cell => `<td>${cell}</td>`).join('')}
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    resultsDiv.innerHTML = tableHTML;
}

// Add this line at the end to load data when page loads
document.addEventListener('DOMContentLoaded', loadInitialData);
    </script>
</body>
</html>
